
Цель: изучить создание виртуальных машин и типов сетевых подключений.
Студент должен знать различия типов сетевых соединений и уметь их использовать.

Развернуть локально стенд из нескольких виртуальных машин (ВМ). Описание стенда:
 - ВМ1 с двумя сетевыми интерфейсами. 
            1-й сетевой интерфейс подключен к сети интернет, так же как и хостовая ОС
            2-й сетевой интерфейс подключен к локальной сети внутри гипервизора
 - ВМ2 с одним сетевым интерфейсом.
  интерфейс подключен к локальной сети внутри гипервизора
На виртуальных машинах должен быть установлен любой из дистрибутивов Linux. (рекомендуется Ubuntu22-24 server)


Задание 1. 

Требуется настроить ВМ1 так, чтобы она выполняла функцию пограничного маршрутизатора,
 где WAN - это интерфейс 1, а LAN - интерфейс 2.
Шлюз по умолчанию для ВМ2 это IP интерфейса 2 от ВМ1.
После успешной настройки с ВМ2 должен быть доступ в интернет.


#### **1. Настройка ВМ1 (маршрутизатор)**

1. **Проверьте интерфейсы**
    ip a
        - Запомните имя интерфейса для **сетевого моста** (обычно `enp0s3`)
        - Запомните имя интерфейса для **внутренней сети** (обычно `enp0s8`)
        
2. **Настройте Netplan**  
    Откройте конфиг:
	    sudo nano /etc/netplan/99_config.yaml
    
    network:
      version: 2
      renderer: networkd
      ethernets:
        enp0s3:  # Интерфейс для интернета (WAN)
          dhcp4: true
        enp0s8:  # Интерфейс для локальной сети (LAN)
          addresses: [192.168.100.1/24]
    
    Примените:
	    sudo netplan apply
    
3. **Включите форвардинг**
    
    echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
    sudo sysctl -p
По умолчанию Linux не пересылает пакеты между сетевыми интерфейсами.
	Включение net.ipv4.ip_forward=1 разрешает:
		Получение пакета на одном интерфейсе (напримр, LAN — enp0s8)
		Перенаправление его на другой интерфейс (например, WAN — enp0s3)
		Таким образом, ВМ2 сможет выходить в интернет через ВМ1
4. **Настройте NAT**    
    
    sudo iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE
    sudo apt install iptables-persistent -y
    sudo netfilter-persistent save
Эти команды настраивают трансляцию сетевых адресов (NAT) на ВМ1, позволяя ВМ2 выходить в интернет через ВМ1.

Это правило:

1. Берёт все пакеты, идущие **из локальной сети (192.168.100.0/24)**
2. "Маскирует" их под WAN-интерфейс ВМ1 (`enp0s3`)
3. Отправляет в интернет

![[Pasted image 20250325203759.png]]
---

#### **2. Настройка ВМ2 (клиент)**

1. **Проверьте интерфейс**    
    - Запомните имя интерфейса (обычно `enp0s3`)
        
2. **Настройте Netplan**
    sudo nano /etc/netplan/99_config.yaml
    
    network:
      version: 2
      renderer: networkd
      ethernets:
        enp0s3:  # Интерфейс локальной сети
          addresses: [192.168.100.2/24]
          routes:
            - to: default
              via: 192.168.100.1  # Шлюз (IP ВМ1)
            - 
          nameservers:
            addresses: [8.8.8.8]
    
    Примените:
    sudo netplan apply
    
- **to: default** - маршрут для всего трафика (0.0.0.0/0)
- **via: 192.168.100.1** - шлюзом будет LAN-интерфейс ВМ1
- Это означает:
    - Весь трафик, кроме локального (192.168.100.0/24), будет отправляться на 192.168.100.1    
    - ВМ1 будет перенаправлять этот трафик в интернет
---

#### **3. Проверка работы**

1. **На ВМ2 выполните**
    
    ping 192.168.100.1  # Проверка связи с ВМ1
    ping 8.8.8.8        # Проверка интернета
    sudo apt update     # Проверка DNS
    
2. **Если интернет не работает**:
    
    - Проверьте NAT на ВМ1: `sudo iptables -t nat -L -v`
    - Проверьте форвардинг: `cat /proc/sys/net/ipv4/ip_forward` (должно быть `1`)
    - Временно добавьте DNS: `echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf`
        

---

### **Итоговая схема**

Copy

[ Интернет ]
    |
  [ WAN (enp0s3) ] → ВМ1 (маршрутизатор) [ LAN (enp0s8): 192.168.100.1 ]
    |
  [ ВМ2 (enp0s3): 192.168.100.2 ]

Теперь ВМ2 выходит в интернет через ВМ1! Если остались вопросы — спрашивайте. 

Задание 2. 

На ВМ2 развернуть APACHE на порту 80.
На ВМ1 развернуть NGINX на порту 80.
Требуется настроить виртуальные машины так, чтобы при обращении с хостовой (где хостятся ВМ) машины на IP адрес 
ВМ1 1-го сетевого интерфейса должна выводиться дефолтная страница Apache, развернутого на ВМ2. 
nginx как front-end к apache!

```text
[Хостовая машина]
       |
       V
[ВМ1: NGINX (порт 80)]  --> [ВМ2: Apache (порт 80)]
       |
       V
  (Проксирует запросы)
```

#### **Настройка ВМ1 (NGINX)**

1. **Установите NGINX**:

    sudo apt update
    sudo apt install nginx -y
    
2. **Настройте проксирование на Apache (ВМ2)**:
    
    
        sudo nano /etc/nginx/sites-available/default
        
    - Найдите блок `location /` и замените его:
            location / {
            proxy_pass http://192.168.100.2;  # IP ВМ2
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        Сохраните (`Ctrl+O` → `Enter` → `Ctrl+X`).
        
`proxy_pass` — это инструкция NGINX, которая:  
**Перенаправляет все запросы** из текущего `location /` на указанный сервер (в вашем случае — Apache на ВМ2).

3. **Проверьте конфиг и перезапустите NGINX**:
        sudo nginx -t  # Проверка синтаксиса
    sudo systemctl restart nginx
    
4. **Откройте порт 80 (если фаервол включён)**:
    sudo ufw allow 80/tcp
    

---

#### **2. Настройка ВМ2 (Apache)**

1. **Установите Apache**:
    sudo apt update
    sudo apt install apache2 -y
    
2. **Проверьте работу Apache**:
    sudo systemctl status apache2
    curl http://localhost  # Должна быть страница "It works!"
    
3. **Откройте порт 80**:
    sudo ufw allow 80/tcp
    

---

#### **3. Настройка сети в VirtualBox**

1. **Для ВМ1**:
    
    - Адаптер 1: **Сетевой мост** (Bridged Adapter) — чтобы получить IP из вашей сети.
        
    - Адаптер 2: **Внутренняя сеть** (Internal Network, например `intnet`).
        
2. **Для ВМ2**:
    
    - Адаптер 1: **Внутренняя сеть** (та же, что у ВМ2, `intnet`).
        
3. **Узнайте IP ВМ1** (для доступа с хоста):  
    На ВМ1 выполните:
    
    bash
    
    Copy
    
    ip a show enp0s3  # Или ваш WAN-интерфейс
    
    Пример вывода:
    
    Copy
    
    inet 192.168.1.100/24  # Этот IP вводите в браузере
    

---

#### **4. Проверка работы**

1. На **хостовой машине** (вашем компьютере) откройте браузер и введите:
    
    Copy
    
    http://192.168.1.100  # IP ВМ1
    
    - Должна появиться **страница Apache с ВМ2**.
        
2. Если страница не загружается:
    
    - Проверьте, что NGINX работает:
        
        bash
        
        Copy
        
        sudo systemctl status nginx
        
    - Проверьте связь между ВМ1 и ВМ2:
        
        bash
        
        Copy
        
        ping 192.168.100.2  # С ВМ1
        curl http://192.168.100.2  # Должен вернуть страницу Apache
        

---

#### **5. Альтернатива: NAT + проброс портов (если нельзя использовать мост)**

1. В VirtualBox для ВМ1:
    
    - Адаптер 1: **NAT**.
        
    - Добавьте проброс портов:
        
        Copy
        
        Хост:8080 → Гость:80
        
2. На хосте обращайтесь по:
    
    Copy
    
    http://localhost:8080
    

---

### **Итог**

- **Основной способ**: Через **Сетевой мост** (`http://IP_ВМ1`).
    
- **Альтернатива**: Через **NAT + проброс портов** (`http://localhost:8080`).
    

Схема работы:

Copy

[Хост] → http://192.168.1.100 → [NGINX (ВМ1)] → [Apache (ВМ2)]

Задание 3.
Настроить проброс портов. portforwarding.
При обращении на порт 2222 (или любой другой порт на ваш выбор)  wan интерфейса вм1 запрос должен  улететь на 22 порт вм2 и мы должны получить доступ к ssh vm2.

Реализовать используя iptables.

#### **Цель**:

При подключении к **порту 2222 WAN-интерфейса ВМ1** запрос должен перенаправляться на **порт 22 ВМ2**, позволяя подключаться к SSH ВМ2 через ВМ1.

[Хост] → SSH:2222 → [ВМ1] → DNAT → [ВМ2:22]
![[Pasted image 20250325220308.png]]
![[Pasted image 20250325220325.png]]![[Pasted image 20250325220335.png]]
P.S. все рабочие конфигурации и сервисы должны работать после перезагрузки!!!

При сдаче нужно будет рассказать о том как настраивается маршрутизатор. Понимать  принципы работы фаервола.
Ориентироваться в открытых_закрытых_проброшенных портах.
Ориентироваться в базовых настройках apache и nginx.
Знать расположение  конфигурационных файлов. уверенно  управлять запуском сервиса.
Ориентироваться и уметь перенастраивать порты для  работы вебсерверов по требованию.
![[Pasted image 20250325220601.png]]![[Pasted image 20250325220615.png]]

1. **Типы сетей в VirtualBox**:
    - **NAT**: Виртуальная машина получает доступ в интернет, но недоступна снаружи.
    - **Сетевой мост (Bridged)**: ВМ получает IP из сети хоста, как физическое устройство.
    - **Внутренняя сеть (Internal Network)**: Изолированная сеть между виртуальными машинами.

![[Pasted image 20250325220711.png]]![[Pasted image 20250325220725.png]]![[Pasted image 20250325220729.png]]![[Pasted image 20250325220734.png]]![[Pasted image 20250325220740.png]]![[Pasted image 20250325220745.png]]![[Pasted image 20250325220749.png]]